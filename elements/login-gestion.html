<link rel="import" href="../bower_components/polymer/polymer-element.html">
<!-- iron elements-->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<!-- paper elements-->
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<!-- login elements-->
<link rel="import" href="login-signin.html">
<link rel="import" href="login-register.html">
<link rel="import" href="login-update.html">

<!--
`login-gestion`
elemento que nos permite hacer la gestion de los usuarios (login y cadastro) a través de Firebase

@demo demo/index.html 
-->

<dom-module id="login-gestion">
  <template>
    <style>
      :host {
         @apply(--layout-vertical);

        margin:auto;
         width: 400px;

      } 

      img{
        width: 35px;
        height: 35px;
      }   

      paper-tab{
        font-family: "Averta","Avenir W02","Avenir",Helvetica,Arial,sans-serif;font-size: 14px;
        --paper-tab-ink:var(--accent-color); 
        width: 100px  
      }

      paper-tabs{
        
        --paper-tabs-selection-bar-color:var(--accent-color);
        --paper-tabs-selection-bar:{
          color:red;
        }
      }


      @media (max-width: 600px){

    
        paper-tabs{
          max-width: 325px
        }

        paper-tab{
          max-width: 325px
        }

      }


    </style>

    <firebase-auth 
            app-name="mask-polymerfire"
            id="auth" 
            user="{{user}}" 
            signed-in="{{signed}}"
            status-known="{{statusKnown}}"
            app="{{fbapp}}">
    </firebase-auth> 

     
  <div class="container">
    <paper-tabs selected="{{signSect}}" attr-for-selected="name">
      <paper-tab name="signin">Entrar</paper-tab>
      <paper-tab name="register">Cadastre-se</paper-tab>
    </paper-tabs>
   
     <iron-pages selected="{{signSect}}" attr-for-selected="name">
            
        <div name="signin">

          <login-signin 
              on-sign-google="signIn"
              on-sign-facebook="signIn" 
              on-email="email"
              signed-in="[[signed]]"
              dato="{{dato}}">
          </login-signin>          
    
     
          <login-update 
              user="{{user}}" 
              fbapp="{{fbapp}}" 
              data="{{data}}" 
              credential="{{credential}}">
        </login-update>
     
        </div>

        <div name="register">
          <login-register 
              on-register="signUp" 
              signed-in="[[signed]]"
              data="{{data}}">
          </login-register>
        </div>  
    </div> 
   
</iron-pages>
          
  </template>

  <script>


  class LoginGestion extends Polymer.Element {
      static get is() { return 'login-gestion'; }
      static get properties() {
        return {
            //propiedad bindeada al componente <firebase-auth> y que recibe seteada desde el componente <login-signin> los valores 'google', 'facebook' o twitter para loguearnos con una de estas redes
            provider:String,

            //objeto del usuario
            user:Object,        

            // propiedad bindeada que hace el enlace con la propiedad SignedIn de <firebase-auth> que nos devuelve 'true' cuando el usuario esté autenticado.
            signed: {
              type: Boolean,
              reflectToAttribute: true,
              value: true,
              notify:true
            },
            // iron-pages, paper-tabs
            signSect: {
              type:String,
              value: 'signin'
            },
            // objeto que nos da acceso a la base de datos de Firebase, y a travès de este objeto, tendremos acceso a los servicios de Firebase: -firebase.auth(); -firebase.database(); -firebase.storage(). IMPORTANTE: quando tengamos problemas de acceso a estos servicios de Firebase a través de Polymerfire podremos acceder a través de este objeto
            fbapp:Object,
            data:Object,
            dato:Object,     
            statusKnown: Boolean,

            //objeto que nos devuelve <firebase-document> con los datos del usuario
            perfilUsuario: {
              type:Object,
              notify: true
            },
          
            credential:String,
        };
      }

      
      // ENLACE con <login-register>. Método para crear un usuario con email y password. Estos dos datos serán propiedades de detail
      
      signUp(e){
          if (this.user){
          //  this.fire('negative-toast','Você já esta logueado');
              alert('ya existe un usuario')
              return false;
          }

          this.$.auth.createUserWithEmailAndPassword(e.detail.email, e.detail.password)
              .catch(function(error){
                  console.log(error);
                  this.errorCode(error);  
              }.bind(this))
              .then(function(user){                        
                  this.saveProfile(user,e.detail);
                      // ENLACE con <my-app>
                  this.dispatchEvent(new CustomEvent('positiveToast',{bubbles:true, composed:true, detail:'Oi ' + e.detail.name + '!'}));
                  this.resetRegister();  
                     //   user.sendEmailVerification()  // envio de email de verificacion               
              }.bind(this));

      } 
      // limpiamos los input después del registro del usuario
      resetRegister(){
          this.data = {
            email:'',
            password: '',
            name:''
          }
      }

         // método para guardar los datos del usuario en Firebase. Le pasamos como parámetro a través de 'user'. Se el usuario se registra a través de e-mail / password, cadastramos su nombre en la base de datos a través del parámetro 'data' (data.name)

      saveProfile(user,data){  
          this.fbapp.database().ref('/users/' + user.uid).set({
              nombre: user.providerData[0].displayName || data.name || 'nome desconhecido', 
              email: user.email || 'no-email@example.com',
              photoURL: user.providerData[0].photoURL || 'http://lucialiu.me/images/portfolio/tastemap/profile-icon.png'
          });      
      }

      //login con email y password; 'dato' es el objeto pasado por el componente <login-signin>, que incluye las propiedades 'dato.email' y 'dato.password'
   
      email(e){  
          console.log('hola')
          
          if (this.user){
              alert('Você já esta logueado');
              return false;
          } 
          this.$.auth.signInWithEmailAndPassword(e.detail.email, e.detail.password)
              .catch(function(error){
                  console.log(error);
                  this.errorCode(error);
              }.bind(this))
              .then(function(result){
                  if (result){
                      this.dispatchEvent(new CustomEvent('positiveToast',{bubbles:true, composed:true, detail:'Oi!'}));
                  this.resetSignin();  
                  }   
              }.bind(this));
      }

      resetSignin(){
          this.dato = {
            email:'',
            password: ''
          }
      } 

       // cuando logueamos con una red social podemos recibir la propiedad 'credential', que nos permite hacer diferentes operaciones con los datos de esas redes sociales, y también nos va a permitir reautenticar al usuario para que pueda hacer las diferentes operativas del componente <login-update> (darse de baja, actualizar la contraseña, etc)
      signIn(e){

           if (this.user){
              this.dispatchEvent(new CustomEvent('negativeToast',{bubbles:true, composed:true, detail: 'Você já está logueado!'}))
              return false;
            }
             console.log(e.detail);
             this.fbapp.auth().signInWithPopup(e.detail)
               .then(function(result){
                  this.credential = result.credential;
                  console.log(this.credential);
                   this.saveProfile(result.user);
                    this.dispatchEvent(new CustomEvent('positiveToast',{bubbles:true, composed:true, detail:'Oi!'}));                  
            
            }.bind(this),
              function(error){
                  this.errorCode(error);                          
            }.bind(this));  
          }

      errorCode(error){
        console.log(error)
        switch (error.code){
            case 'auth/provider-already-linked' || 'auth/credential-already-in-use':
            var message = 'Red Social ya asociada a un usuario';
            this.fireEvent(message)
            break
            case 'auth/invalid-credential':
            var message = 'Credencial de autenticación expirada';
            this.fireEvent(message)
            break
            case 'auth/email-already-in-use':
             var message = 'Email ya asociado a un usuario';
            this.fireEvent(message)
            break
            case 'auth/invalid-email' || 'auth/wrong-password':
            var message = 'Email o Password inválidos';
            this.fireEvent(message)
            break
            case 'auth/weak-password':
            var message = 'El password debe tener mínimo 6 caracteres';
            this.fireEvent(message)
            break        
            case 'auth/user-disabled':
            var message = 'Usuario no autorizado';
            this.fireEvent(message)
            break
            case 'auth/user-not-found':
             var message = 'No existe un usuario asociado a ese email';
            this.fireEvent(message)
            break
            case 'auth/argument-error':
             var message = 'Email inválidol';
            this.fireEvent(message)
            break                     
        }
      } 

      fireEvent(message){
         this.dispatchEvent(new CustomEvent('negativeToast',{bubbles:true, composed:true, detail:message}))
      }

      

     
     
    }

    window.customElements.define(LoginGestion.is, LoginGestion);



  </script>
</dom-module>
